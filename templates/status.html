
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Procesando Video...</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        // Esta función sondeará nuestra API de estado para obtener actualizaciones
        function checkJobStatus(jobId) {
            const statusDiv = document.getElementById('status-updates');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const resultDiv = document.getElementById('result');

            const interval = setInterval(() => {
                fetch(`/api/status/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Actualizar los detalles del estado
                        statusDiv.innerHTML = `<p>${data.details}</p>`;
                        
                        // Actualizar la barra de progreso
                        progressBar.style.width = data.progress;
                        progressText.textContent = data.progress;
                        
                        // Comprobar si la tarea ha terminado
                        if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                            clearInterval(interval);
                            progressBar.style.width = '100%';
                            
                            if (data.state === 'SUCCESS') {
                                progressText.textContent = '¡Completado!';
                                document.querySelector('h1').textContent = '¡Video Generado con Éxito!';
                                // Mostrar los resultados finales
                                const result = data.result;
                                resultDiv.innerHTML = `
                                    <h3>${result.title}</h3>
                                    <p><strong>Descripción:</strong> ${result.description}</p>
                                    <p><strong>Enlace de YouTube:</strong> <a href="${result.youtube_url}" target="_blank">${result.youtube_url}</a></p>
                                    <p><strong>Archivos generados:</strong></p>
                                    <ul>
                                        <li>Video: <a href="/videos/${result.video_path.split('/').pop()}">${result.video_path}</a></li>
                                        ${result.song_paths.map(p => `<li>Canción: <a href="/songs/${p.split('/').pop()}">${p}</a></li>`).join('')}
                                    </ul>
                                    <a href="/" class="button">Crear otro video</a>
                                `;
                            } else { // FAILURE
                                progressText.textContent = '¡Error!';
                                document.querySelector('h1').textContent = 'La Tarea ha Fallado';
                                resultDiv.innerHTML = `
                                    <p>Ocurrió un error durante el proceso:</p>
                                    <pre style="background-color: #333; color: #ff8a80; padding: 15px; border-radius: 5px;">${data.details}</pre>
                                    <a href="/" class="button">Intentar de Nuevo</a>
                                `;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error al sondear el estado:', error);
                        statusDiv.innerHTML = `<p>Error al conectar con el servidor. Reintentando...</p>`
                    });
            }, 2500); // Sondear cada 2.5 segundos
        }

        // Iniciar el sondeo cuando la página se cargue
        window.onload = () => {
            const jobId = document.body.dataset.jobId;
            checkJobStatus(jobId);
        };
    </script>
</head>
<body data-job-id="{{ job_id }}">
    <div class="container">
        <h1>Generando tu Video...</h1>
        <p>Tu video se está procesando en segundo plano. Puedes ver el progreso a continuación.</p>

        <div class="progress-container">
            <div id="progress-bar-container">
                <div id="progress-bar" style="width: 0%;"></div>
            </div>
            <span id="progress-text">0%</span>
        </div>

        <div id="status-updates">
            <p>Inicializando...</p>
        </div>

        <div id="result">
            <!-- Los detalles del video final aparecerán aquí -->
        </div>
    </div>
</body>
</html>
